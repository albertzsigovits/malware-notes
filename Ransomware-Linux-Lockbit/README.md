# Dumping plain-text strings from the Linux-ESXi variant of Lockbit ransomware

## Discovered by Trend Micro
```Bash
https://www.trendmicro.com/en_us/research/22/a/analysis-and-Impact-of-lockbit-ransomwares-first-linux-and-vmware-esxi-variant.html
```

## SHA256
```Bash
f3a1576837ed56bcf79ff486aadf36e78d624853e9409ec1823a6f46fd0143ea
67df6effa1d1d0690c0a7580598f6d05057c99014fcbfe9c225faae59b9a3224
ee3e03f4510a1a325a06a17060a89da7ae5f9b805e4fe3a8c78327b9ecae84df
```

## Executing the ransomware
```Bash
sandworm@arrakis:~$ sudo ./lockbit3
```

Generally, the process will hang on read(). Tried to debug it in gdb.  
```GDB
(No debugging symbols found in /lib64/ld-linux-x86-64.so.2)
0x00007f15f11b9142 in __GI___libc_read (fd=0, buf=0x20b72e0, nbytes=1024)
    at .. /sysdeps/unix/sysv/linux/read.c:26
26       ../sysdeps/unix/sysv/linux/read.c: No such file or directory.
```

Added a bunch of deb-src repos to my /etc/apt/sources.list to apt source glibc/libc6. However that does not solve the issue.  
If you try to strace the process, will fail due to having two ptrace functions inside.  
```Bash
getppid()                = 15885
ptrace(PTRACE_ATTACH, 15885                         
```

Tried to circumvent this via:  
```Bash
/etc/sysctl.d/10-ptrace.conf:
	kernel.yama.ptrace_scope = 0
```

And via:  
```Bash
echo "0" | sudo tee /proc/sys/kernel/yama/ptrace_scope
```

No luck.  
The ptrace calls can be patched from the binary, but then the process will still hang on read().  
Same results on both ESXi and Ubuntu images.  
Went down the rabbit hole of differint glibc/libc6 version as a cause.  

```Bash
sandworm@arrakis:~$ strings lockbit3 | grep -i libc
libc.so.6
GLIBC_2.2.5
GLIBC_2.3.2
GLIBC_2.3
GLIBC_2.4
GLIBC_2.3.4
```

My current image:  
```Bash
sandworm@arrakis:~$ ldd --version ldd
ldd (Ubuntu GLIBC 2.31-0ubuntu3) 2.31
```

```Bash
sandworm@arrakis:~$ strings lockbit3 | grep -i libc
String dump of section '.comment':
  [    0]  GCC: (GNU) 4.4.7 20120313 (Red Hat 4.4.7-23)
```

No conclusion.  
Going to try other kernels with different glibc versions later on.  

## Continuing and finding corresponding PID of the hanging process
```Java
sandworm@arrakis:/tmp$ ps aux | grep -i lockb
root       15884  0.0  0.1  23440  4788 pts/0    t+   09:44   0:00 sudo ./lockbit3 -i
root       15885  0.0  0.0   2888   952 pts/0    S+   09:44   0:00 ./lockbit3 -i
```

## Finding related memory regions
```Go
sandworm@arrakis:/tmp$ sudo cat /proc/15885/maps
00400000-0043c000 r-xp 00000000 08:05 264340                             /tmp/lockbit3
0063b000-0063c000 r--p 0003b000 08:05 264340                             /tmp/lockbit3
0063c000-00640000 rw-p 0003c000 08:05 264340                             /tmp/lockbit3
0121b000-0123c000 rw-p 00000000 00:00 0                                  [heap]
```

## Dumping the memory section via gdb
```YAML
sandworm@arrakis:/tmp$ sudo gdb --pid 15885
GNU gdb (Ubuntu 9.2-0ubuntu1~20.04.1) 9.2
(gdb) dump memory /tmp/lockbit_memdump 0x0063c000 0x00640000
```

## XOR key
```YAML
0x39
```

## Plain-text strings
```JSON
[+] file %s decrypted.
[-] file %s not decrypted.
/tmp/
locklog
.llg
lwndotfyrm:i:b:e:s:p:a:z:
Usage: %s [OPTION]... -i '/path/to/crypt'
Recursively crypts files in a path or by extention.
Mandatory arguments to long options are mandatory for short options too.
  -i, --indir        path to crypt
  -m, --minfile      minimal size of a crypted file, no less than 4096
  -r, --remove       self remove this file after work
  -l, --log          prints the log to the console
  -n, --nolog        do not print the log to the file /tmp/locker.log
  -d, --daemonize    runs a program as Unix daemon
  -w, --wholefile    encrypts whole file
  -b, --beginfile    encrypts first N bytes
  -e, --extentions   encrypts files by extentions
  -o, --nostop       prevent to stop working VM
  -t, --wipe         wipe free space
  -s, --spot         upper bound limitation value of spot in Mb
  -p, --pass         password
  -f, --full         full log
  -a, --delay        start delay in minutes
  -y, --noexts       do not search for extentions
!!!-Restore-My-Files-!!!
            ~~~ LockBit 2.0 the world's fastest ransomware since 2019~~~
>>>> Your data are stolen and encrypted
	The data will be published on TOR website if you do not pay the ransom 
	Links for Tor Browser:
	http://lockbitapt6vx57t3eeqjofwgcglmutr3a35nygvokja5uuccip4ykyd.onion 
	http://lockbitaptq7ephv2oigdncfhtwhpqgwmqojnxqdyhprxxfpcllqdxad.onion
	http://lockbitapt34kvrip6xojylohhxrwsvpzdffgs5z4pbbsywnzsbdguqd.onion
	Links for the normal browser
	https://lockbitapt.uz
	http://lockbitapt6vx57t3eeqjofwgcglmutr3a35nygvokja5uuccip4ykyd.onion.ly
	http://lockbitaptq7ephv2oigdncfhtwhpqgwmqojnxqdyhprxxfpcllqdxad.onion.ly
	http://lockbitapt34kvrip6xojylohhxrwsvpzdffgs5z4pbbsywnzsbdguqd.onion.ly
>>>> What guarantees that we will not deceive you? 
	We are not a politically motivated group and we do not need anything other than your money. 
    
	If you pay, we will provide you the programs for decryption and we will delete your data. 
	Life is too short to be sad. Be not sad, money, it is only paper.
    
	If we do not give you decrypters, or we do not delete your data after payment, then nobody will pay us in the future. 
	Therefore to us our reputation is very important. We attack the companies worldwide and there is no dissatisfied victim after payment.
    
	You can obtain information about us on twitter https://twitter.com/hashtag/lockbit?f=live
    
>>>> You need contact us and decrypt one file for free on these TOR sites with your personal decryption ID 
	Download and install TOR Browser https://www.torproject.org/
	Write to a chat and wait for the answer, we will always answer you. 
	Sometimes you will need to wait for our answer because we attack many companies.
	Links for Tor Browser:
	http://lockbitsup4yezcd5enk5unncx3zcy7kw6wllyqmiyhvanjj352jayid.onion
	http://lockbitsap2oaqhcun3syvbqt6n5nzt7fqosc6jdlmsfleu3ka4k2did.onion
	http://lockbitsupn2h6be2cnqpvncyhj4rgmnwn44633hnzzmtxdvjoqlp7yd.onion
	http://lockbitsapfq6mp7djlmbtk4uj53vnueldrjsgfjew3ccridkufmmmyd.onion
	http://lockbitsapliyedzmz5yjcoj27yfgeix6rzrhj7ss4kvfmdv6iyvxlad.onion
	http://lockbitsapu34zkhnafamvkegbmdfh5yvqjbth6g376z2tgvef34jnqd.onion
	http://lockbitsapzxzkpf33daeacsarqdtjjlkouxd7emxaqk7f3svavbmmad.onion
	Link for the normal browser
	https://lockbitsupp.uz
	If you do not get an answer in the chat room for a long time, the site does not work and in any other emergency, you can contact us in jabber or tox.
	Tox ID LockBitSupp: 3085B89A0C515D2FB124D645906F5D3DA5CB97CEBEA975959AE4F95302A04E1D709C3C4AE9B7
	XMPP (Jabber) Support: 598954663666452@exploit.im 365473292355268@thesecure.biz
>>>> Your personal decryption ID: 
>>>> Warning! Do not DELETE or MODIFY any files, it can lead to recovery problems!
>>>> Warning! If you do not pay the ransom we will attack your company repeatedly again!
>>>> Advertisement
	Would you like to earn millions of dollars $$$ ?
	Our company acquire access to networks of various companies, as well as insider information that can help you steal the most valuable data of any company. 
	You can provide us accounting data for the access to any company, for example, login and password to RDP, VPN, corporate email, etc. 
	Open our letter at your email. Launch the provided virus on any computer in your company.
	You can do it both using your work computer or the computer of any other employee in order to divert suspicion of being in collusion with us.
	Companies pay us the foreclosure for the decryption of files and prevention of data leak.
	You can contact us using Tox messenger without registration and SMS https://tox.chat/download.html. 
	Using Tox messenger, we will never know your real name, it means your privacy is guaranteed.
	If you want to contact us, write in jabber or tox. 
	Tox ID LockBitSupp: 3085B89A0C515D2FB124D645906F5D3DA5CB97CEBEA975959AE4F95302A04E1D709C3C4AE9B7
	XMPP (Jabber) Support: 598954663666452@exploit.im 365473292355268@thesecure.biz
	If this contact is expired, and we do not respond you, look for the relevant contact data on our website via Tor or Brave browser 
	Links for Tor Browser:
	http://lockbitapt6vx57t3eeqjofwgcglmutr3a35nygvokja5uuccip4ykyd.onion 
	http://lockbitaptq7ephv2oigdncfhtwhpqgwmqojnxqdyhprxxfpcllqdxad.onion
	http://lockbitapt34kvrip6xojylohhxrwsvpzdffgs5z4pbbsywnzsbdguqd.onion
	Links for the normal browser
	https://lockbitapt.uz
	http://lockbitapt6vx57t3eeqjofwgcglmutr3a35nygvokja5uuccip4ykyd.onion.ly
	http://lockbitaptq7ephv2oigdncfhtwhpqgwmqojnxqdyhprxxfpcllqdxad.onion.ly
	http://lockbitapt34kvrip6xojylohhxrwsvpzdffgs5z4pbbsywnzsbdguqd.onion.ly
vm-support --listvms
/bin/vim-cmd hostsvc/enable_ssh
[+] ESXi: enable_ssh
[-] ESXi: enable_ssh
/sbin/vmdumper -l
/sbin/vmdumper %d suspend_vm
[+] Suspended VM ID %d
[-] Suspend VM ID %d ERROR %d. Trying %d...
/tmp/locker.pid
/home
/var/log
%H:%M:%S
[%s][%lu][+] End file %s size %lu time %lu is encrypted. Checksum after encryption %lu
[%s][%lu][-] End file %s remained intact.
[%s][%lu][?] File %s need ram %d
[%s][%lu][-] File %s MMAP ERROR %d
[%s][%lu][?] Free ram %d, need ram %d
[%s][%lu][+] Start encrypting file %s spot %d from %d. Original checksum %lu
[%s][%lu][+]     Encrypting file %s...
vmdk
vswp
lockbit
[%s][%lu][+] Start encrypting file %s. Original checksum %lu
[%s][%lu][+] Start encrypting file %s
[%s][%lu][+]    Encrypting file %s...
/bin/vm-support
/sbin/vm-support
/bin/
/sbin/
/sbin/vmdumper
/bin/vim-cmd
[%s][%lu][+] Encrypt entry %s
%02X
/**/*
%s/%s
%*s[%s]
%*s- %s
[%s][%lu][+] Add directory to encrypt: %s
[-] glob ERROR %d
remove
minfile
indir
nolog
WVJMVI9full
wholefile
beginfile
daemonize
extensions
spot
wipe
pass
delay
repeat
noexts
[%s][%ul][+] ------------------Start searching for extentions------------------
[%s][%ul][+] Launch parameters: %s -i '%s' -m %d -w %d -b %d -r %d -l %d -n %d -d %d -e '%s' -s %d -p %s -o %d -t %d -f %d -a %d -z %d -y %d
Date: %d/%m/%Y Time: %H:%M:%S
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
uname -a: %s%s%s
Processor: %s, %d cores
Volumes in the system:
Virtual machines for skipping: %s
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Total files..................%lu
Total VMs....................%lu
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Encrypted files..............%lu
Encrypted VMs................%lu
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Total encrypted size.........%lu Mb
Time spent for encryption....%lu sec
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
LockBit Linux/ESXi locker V: 1.2
esxcli vm process kill --type
force --world-id
3}VW
_VK^\M
ZU\XW
@VLK
NVKRJIXZ\
[%s][%lu][+] %s %d 
Suspended VM ID
[%s][%lu][-] %s %d %s %d %s %d... 
ERROR
Trying
[%s][%lu][+] %s
[%s][%lu][-] %s
ESXi: enable_ssh
Same process is running. Exit.
kill -9 `ps
grep %s
cut -d' ' -f0`
ps -ef
grep '%s'
grep -v grep
awk '{print $2}'
xargs -r kill -9
vmware -v
uname -a
(Running)
[%s][%lu][+] Wipe partition %s
[%s][%lu][+] End wiping partition %s
Start wiping all partitions.
All partitions have been wiped.
df -h
displayName = "
[%s][%lu][+] VM %s will be skipped.
~~~~~~~~~~~~~~~Hardware~~~~~~~~~~~~~~~~~~
lspci -vvv
vim-cmd hostsvc/autostartmanager/enable_autostart false
Disabled AutoStart
There are %d processors in the system.
esxcfg-scsidevs -l
egrep -i 'display name
vendor'
Processor: %s, %d cores
vim-cmd hostsvc/hostsummary
grep cpuModel
cut -d '"' -f2
head -c -1
esxcli storage filesystem list
tail -n +3
Enter password:
ls -Ral /
ls -alR /vmfs/
[%s][%lu][+] wipe error %d
pciconf -lv
/sbin/sysctl hw
grep hw.model
cut -d ':' -f2
lscpu
grep "Model name"
cut -d ':' -f2
egrep 'da[0-9]
ad[0-9]
cd[0-9]' /var/run/dmesg.boot
lsblk -io KNAME,TYPE,SIZE,MODEL
tail -n +2
ps auxfww
ps -TcJnN
ps auxf
/etc/rc.local
/etc/
 -i '%s' -m %d -b %d -e '%s' -s %d -p '%s' -a %d -z %d
/etc/sudoers.d
/usr/share
a-bvmsyslogd
!!!-Restore-My-Files-!!!,lockbit,locklog
VMware vCenter,VMware-VirtualSAN-Witness
rar,zip,7zip,txt,doc,jpg,png,mp3,vbm,vrb,vbk,vmdk,zip,msi,iso,tar,sql,vlb,vom,vsm,vsb,vab
test
```

## IoCs:
```YAML
Strings:
~~~ LockBit 2.0 the world's fastest ransomware since 2019~~~
LockBit Linux/ESXi locker V: 1.2
!!!-Restore-My-Files-!!!
locklog

Targets:
VMware vCenter
VMware-VirtualSAN-Witness

Added extension:
.llg

Extension list:
rar,zip,7zip,txt,doc,jpg,png,mp3,vbm,vrb,vbk,vmdk,zip,msi,iso,tar,sql,vlb,vom,vsm,vsb,vab

PID file:
/tmp/locker.pid

Web:
https://lockbitapt.uz
http://lockbitsup4yezcd5enk5unncx3zcy7kw6wllyqmiyhvanjj352jayid.onion
http://lockbitsap2oaqhcun3syvbqt6n5nzt7fqosc6jdlmsfleu3ka4k2did.onion
http://lockbitsupn2h6be2cnqpvncyhj4rgmnwn44633hnzzmtxdvjoqlp7yd.onion
http://lockbitsapfq6mp7djlmbtk4uj53vnueldrjsgfjew3ccridkufmmmyd.onion
http://lockbitsapliyedzmz5yjcoj27yfgeix6rzrhj7ss4kvfmdv6iyvxlad.onion
http://lockbitsapu34zkhnafamvkegbmdfh5yvqjbth6g376z2tgvef34jnqd.onion
http://lockbitsapzxzkpf33daeacsarqdtjjlkouxd7emxaqk7f3svavbmmad.onion
http://lockbitapt6vx57t3eeqjofwgcglmutr3a35nygvokja5uuccip4ykyd.onion 
http://lockbitaptq7ephv2oigdncfhtwhpqgwmqojnxqdyhprxxfpcllqdxad.onion
http://lockbitapt34kvrip6xojylohhxrwsvpzdffgs5z4pbbsywnzsbdguqd.onion
http://lockbitapt6vx57t3eeqjofwgcglmutr3a35nygvokja5uuccip4ykyd.onion.ly
http://lockbitaptq7ephv2oigdncfhtwhpqgwmqojnxqdyhprxxfpcllqdxad.onion.ly
http://lockbitapt34kvrip6xojylohhxrwsvpzdffgs5z4pbbsywnzsbdguqd.onion.ly

Tox ID LockBitSupp:
3085B89A0C515D2FB124D645906F5D3DA5CB97CEBEA975959AE4F95302A04E1D709C3C4AE9B7

XMPP (Jabber) Support:
598954663666452@exploit.im
365473292355268@thesecure.biz
```

## YARA
```C++
rule Lockbit_Linux_ESXi_memory_strings
{
	meta:
		author = "Albert Zsigovits"
		url = "https://github.com/albertzsigovits/malware-notes/tree/master/Ransomware-Linux-Lockbit"
	strings:
		$str1 = "  -e, --extentions   encrypts files by extentions" ascii wide
		$str2 = "!!!-Restore-My-Files-!!!" ascii wide
		$str3 = "VMware vCenter,VMware-VirtualSAN-Witness" ascii wide
		$str4 = "/tmp/locker.pid" ascii wide
		$str5 = "locklog" ascii wide
	condition:
		3 of them
}
```

```C++
rule Lockbit_Linux_ESXi_XOR_function
{
	meta:
		author = "Albert Zsigovits"
		url = "https://github.com/albertzsigovits/malware-notes/tree/master/Ransomware-Linux-Lockbit"
	strings:
		$xor = { 0F B6 05 ?? ?? 23 00 BA ?? ?? 63 00 ?? ?? 40 00 89 C1 32 0A 88 0A 48 83 C2 01 84 C9 75 F2 }
	condition:
		$xor
}